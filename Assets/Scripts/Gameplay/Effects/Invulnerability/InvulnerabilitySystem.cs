using UnityEngine;
using Leopotam.Ecs;
using DG.Tweening;
using RiderGame.SO;

namespace RiderGame.Gameplay
{
    public class InvulnerabilitySystem : IEcsRunSystem
    {
        private readonly EcsFilter<BaseEffect, Invulnerability> _fInvulnerabilityObjects;

        public static void AddInvulnerablility(ref EcsEntity entity, PlayerConfiguration playerConfigs, SpriteRenderer renderer)
        {
            var baseEffect = new BaseEffect
            {
                duration = playerConfigs.InvunerabilityDuration
            };
            entity.Replace(baseEffect);

            var invulnerability = new Invulnerability
            {
                blinkingSequence = InitSpriteBlinkingSequence(playerConfigs, renderer)
            };
            entity.Replace(invulnerability);
        }

        public void Run()
        {
            foreach(var i in _fInvulnerabilityObjects)
            {
                ref var entity = ref _fInvulnerabilityObjects.GetEntity(i);
                ref var baseEffect = ref _fInvulnerabilityObjects.Get1(i);
                ref var invulnerability = ref _fInvulnerabilityObjects.Get2(i);

                if (!baseEffect.isEnd) return;

                invulnerability.blinkingSequence.Kill();
                entity.Del<Invulnerability>();
            }
        }

        private static Sequence InitSpriteBlinkingSequence(PlayerConfiguration playerConfigs, SpriteRenderer renderer)
        {
            var sequence = DOTween.Sequence();

            sequence.Append(renderer.DOFade(0, playerConfigs.InvunerabilityBlinkInterval));
            sequence.Append(renderer.DOFade(1, playerConfigs.InvunerabilityBlinkInterval));

            sequence.SetLoops(-1);
            return sequence;
        }
    }
}
